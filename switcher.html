<!DOCTYPE html>
<html>
<head>
<TITLE>Switcher</TITLE>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.5/jquery.mobile.min.js"></script>

<script>
var all_switches={};
$(document).ready(function(){
    // get the list of switches to poll
    var switchesJSON = $.ajax( {'url':"switches.json", 'cache':false, 'dataType': "json" })
        .fail(function() {
            alert( "cannot find any switches" );
        })
        .always(function(data) {
            // create a section for each switch
            $('#switches').html('<div data-role="collapsible-set" id="switches-set"></div>');
            $.each(data.switches, function(i,obj) {
                console.log(obj);
                var new_id="SW-"+obj.DisplayName;
                console.log(new_id);
                
                $('#switches-set').append('<div data-role="collapsible" data-collapsed="true" id="'+new_id+'"> \
                                       <h3 id="colapseable-header-'+new_id+'"><span>'+new_id+'</span><img id="imgSignal-'+new_id+'" src="images/wifi_a1.png"  height="25" width="20" align="right"></h3> \
                                       <p id="colapseable-content-'+new_id+'"><span> \
                                               <div class="ui-field-contain"><label for="slider-fill'+new_id+'">Delay mins:</label> \
                                               <input type="range" name="slider-fill'+new_id+'" id="slider-fill-'+new_id+'" value="60" min="0" max="300"  step="30" data-highlight="true"></div> \
                                               </span></p><table id="infotbl-'+new_id+'"> \
                                       </table><table id="jobtbl-'+new_id+'"></table></div>');
                $('#switches-set').collapsibleset().trigger('create');
 
                all_switches[new_id]=obj;
                all_switches[new_id].id=new_id;
                setInterval(UpdateSwitchData(new_id),5000);
            });
        });

    function takeAction(url,id){
        if(url.lastIndexOf("&mins=60")){  // if the url includes mins it's a delyed action, use the value from the slider.
                var v=$("#slider-fill-"+id).val();
                url=url.replace("&mins=60", "&mins="+v);
            }
        $.getJSON(url+'&callback=?', function(result){
            UpdateSwitchData(id);
        });
    }


    function UpdateSwitchData(id){
        ip=all_switches[id].ip;
        
        var switchinfoJSON = $.ajax( {'url':"http://"+ ip +"/cgi-bin/json.cgi", 'cache':false, 'dataType': "jsonp" })
            .fail(function() {
                $('#imgSignal-'+id).attr('src',"images/wifi_a2.png");
                alert( "cannot contact" );
            })
            .done(function(data) { // enable switch
                //add the data from the device to the array
                console.log(all_switches[id]);
                $.extend(all_switches[id],data);
                
                //check the wifi signal
                var dBm=eval(all_switches[id].info.signal);
                if(dBm>-46) dBm=46; 
                var imgSig=("images/wifi_a"+Math.round(((2 * (dBm + 100)) / 20)+1) + ".png");
                $('#imgSignal-'+id).attr('src',imgSig);
                console.log($('#imgSignal-'+id));
                
                // show actions
                $('#colapseable-header-'+id+' span').html(all_switches[id].DisplayName);
                console.log(all_switches[id]);
                $('#colapseable-content-'+id+' span').html('');
                $.each(all_switches[id].links.actions, function (key, data) {
                    console.log(key);
                    //$('#colapseable-content-'+id+' span').append('<a href="'+data+'" class="ui-btn" id="action-"'+key+'>'+key+'</a>');
                    $('#colapseable-content-'+id+' span').append('<button class="ui-btn" id="'+id+'-action-'+key+'">'+key+'</button>');
                
                $('#'+id+'-action-'+key).click({url:data }, function(evt){
                        console.log(evt);
                        takeAction(evt.data.url,id);
                    });
                });
                
                //show network info
                $('#infotbl-'+id).empty();
                $('#infotbl-'+id).append('<tr><td>Uptime:</td><td>'+all_switches[id].info.uptime+'</td></tr>');
                $('#infotbl-'+id).append('<tr><td>IP:</td><td>'+all_switches[id].ip+'</td></tr>');
                $('#infotbl-'+id).append('<tr><td>MAC:</td><td>'+all_switches[id].info.macaddr+'</td></tr>');
                $('#infotbl-'+id).append('<tr><td>BSID:</td><td>'+all_switches[id].info.ssid+'</td></tr>');
                $('#infotbl-'+id).append('<tr><td>Channel:</td><td>'+all_switches[id].info.channel+'</td></tr>');
                $('#infotbl-'+id).append('<tr><td>Signal:</td><td>'+all_switches[id].info.signal+'dB</td></tr>');
                
                // show wifi info
                $('#right-'+id+' span').append('<span>'+all_switches[id].info.ssid+'</span></br>');
                $('#right-'+id+' span').append('<span>ch '+all_switches[id].info.channel+'</span>');
                
                //update switch based on actual reported state
                $.getJSON(all_switches[id].links.meta.state+'&callback=?', function(result){
                    console.log(result);
                    $('#colapseable-header-'+id+' span').html(all_switches[id].DisplayName + " (" + result.state + ")");
                });
                
                //list any scheduled jobs
                var getjobs_url="http://"+ip+"/cgi-bin/json.cgi?get=jobs";
                $('#jobtbl-'+id).empty();
                $.getJSON(getjobs_url+'&callback=?', function(result){
                    $.each(result.jobs, function (key,data) {
                        console.log(data);
                        var action = ((data.queue == 'b') ? 'on' : 'off');
                        var cancel_url="http://"+ip+"/cgi-bin/json.cgi?canceljob="+data.jobid;
                        $('#jobtbl-'+id).append('<tr><td>'+action+'</td><td>'+data.date+'</td><td><a href="'+cancel_url+'" class="ui-btn ui-icon-delete ui-btn-icon-left " >cancel</a></td></tr>');
                    });
                });
                
            });
        }
    });

</script>
</head>
<body>
<div data-role="page" id="index">
    <div data-role="header">
		<h1>Switcher</h1>
	</div><!-- /header -->

	<div role="main" class="ui-content Table" id="switches">  
    </div><!-- /content -->

	<div data-role="footer">
		<h4>Switcher</h4>
	</div><!-- /footer -->

</div><!-- /page -->
</body>
</html>

